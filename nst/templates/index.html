<!DOCTYPE html5>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <!-- Font Awesome cdn -->
        <script src="https://kit.fontawesome.com/ca62398c98.js" crossorigin="anonymous"></script>
        <!-- Material Icons Collection -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- tab icon -->
        <link rel="icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/image/1x_web/ic_brush_white_48dp.png">
        <title>Art.ai</title>

        <!-- Custom CSS -->
        <style>
            body {
                background-image: url('https://www.itl.cat/pngfile/big/157-1572191_hd-wallpapers-for-website-background.jpg');
                background-size: cover;
                background-position: center;
            }
            .card, .card-action, .card-image{
                border-radius: 25px !important;
            }
            img{
                display: 'none';
                width: auto !important;
                max-width: 100%;
                max-height: 150px;
                margin-left: auto;
                margin-right: auto;
            }
            .mr {
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <!-- NavBar -->
        <div class='navbar-fixed'>
            <nav class='transparent'>
                <div class="nav-wrapper">
                    <div class="container">
                        <a href="#" class="brand-logo left"><i class="material-icons">brush</i>Art.ai</a>
                        <!-- <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a> -->
                        <!-- <ul class="right hide-on-med-and-down"> -->
                        <ul class="right">
                            <li><a href="#">Code</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <!-- Mobile SideBar
        <ul id="mobile-demo" class="sidenav">
            <li><a href="#">About</a></li>
            <li><a href="#">Code</a></li>
        </ul> -->

        <!-- Main Section -->
        <div class='container'>
            <div class='row valign-wrapper', style='margin-top: 75px;'>
                <!-- Content Image -->
                <div class='col s12 m4'>
                    <div class="card hoverable green lighten-2">
                        <div class="card-image cimg center-align">
                            <input type="file" accept="image/*" id="contentimage" name="cimg" class="hide" onchange="loadfile(event, 'cimg')">
                            <img id="cimg" class="materialboxed responsive-img" />
                        </div>
                        <div class="card-content center">
                            <span class="card-title">Content Image</span>
                            <h6>The image we want to transfer a style to!</h6>
                        </div>
                        <div class="card-action center">
                            <a class="waves-effect waves-light btn green darken-2 z-depth-5" onclick="$('#contentimage').click();">
                                <i class="material-icons left">add_a_photo</i>
                                Browse
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Style Image -->
                <div class='col s12 m4'>
                    <div class="card hoverable red lighten-2">
                        <div class="card-image simg center-align">
                            <input type="file" accept="image/*" id="styleimage" name="simg" class="hide" onchange="loadfile(event, 'simg')">
                            <img id="simg" class="materialboxed responsive-img" />
                        </div>
                        <div class="card-content center">
                            <span class="card-title">Style Image</span>
                            <h6>The image we want to transfer the style from!</h6>
                        </div>
                        <div class="card-action center">
                            <a class="waves-effect waves-light btn red darken-2 z-depth-5" onclick="$('#styleimage').click();">
                                <i class="material-icons left">add_a_photo</i>
                                Browse
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Output Image -->
                <div class='col s12 m4'>
                    <div class="card hoverable cyan lighten-2">
                        <div class="card-image oimg center-align">
                            <img id="oimg" class="materialboxed responsive-img" />
                        </div>
                        <div class="card-content center">
                            <span class="card-title">Output Image</span>
                            <h6>The image that contains the final result!</h6>
                        </div>
                        <div class="card-action center">
                            <a class="waves-effect waves-light btn-floating cyan darken-2 z-depth-5"><i class="material-icons">settings</i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execute Command -->
        <div class="center">
            <a class="waves-effect waves-light btn orange darken-2 z-depth-5" onclick="transfer()"><i class="material-icons left">play_arrow</i>Run</a>
        </div>

        <!-- preloader -->
        <div class="container loader" style="margin-top: 15px; display: none;">
            <span class="white-text"> Progress
                <span class="progress">
                    <div class="indeterminate"></div>
                </span>
            </span>
        </div>

        <footer class="page-footer transparent z-depth-5", style="margin-top: 60px;">
            <div class="container">
                <div class="row">
                    <div class="col l6 s12">
                        <h5 class="white-text">Neural Style Transfer</h5>
                        <p class="grey-text text-lighten-4" style="margin-top: 0px;">Based on 
                            <a href="https://arxiv.org/pdf/1508.06576.pdf">A Neural Algorithm of Artistic Style</a>
                        </p>
                        <h5 class="white-text">Developer</h5>
                        <p class="grey-text text-lighten-4" style="margin-top: 0px;">Rohit Phulchand Jain</p>
                    </div>
                    <div class="col l4 offset-l2 s12">
                    <h5 class="white-text">Contact</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="mailto:rohitrocks2801@gmail.com"><i class="fas fa-envelope mr"></i>Email</a></li>
                        <li><a class="grey-text text-lighten-3" href="https://github.com/Rohit-Jain-2801"><i class="fab fa-github mr"></i>GitHub</a></li>
                        <li><a class="grey-text text-lighten-3" href="https://www.linkedin.com/in/rohit-jain-2801/"><i class="fab fa-linkedin mr"></i>LinkedIn</a></li>
                    </ul>
                </div>
              </div>
            </div>
            <div class="footer-copyright center">
                <div class="container">
                    Copyright Â© 2020 Art.ai
                </div>
            </div>
        </footer>


        <!-- Minified jquery cdn-->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <!-- socketio cdn -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
        <!-- numjs cdn -->
        <!-- <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script> -->

        <!-- Custom Jquery script -->
        <script>
            // After page is loaded
            $(document).ready(function(){
                $('.sidenav').sidenav();

                socket = io();
                // socket = io.connect('http://localhost:5000/')
                // socket = io.connect('http://127.0.0.1:5000/', {transport: ['websocket'], upgrade: false});

                socket.on('connect', function(){
                    console.log('Connected!');
                });

                socket.on('disconnect', function(){
                    console.log('Disconnected!');
                    alert('Server Disconnected!');
                });

                // for displaying output
                socket.on('output', function(imgdata){
                    $('.loader').css('display', 'none');
                    display('oimg', imgdata);
                });
            });

            // // for image dimensions
            // tmp_img = new Image();
            // tmp_img.onload = () => {
            //     console.log(tmp_img.name)
            //     window[tmp_img.name] = {
            //         'width': tmp_img.width,
            //         'height': tmp_img.height
            //     }
            // };

            // for displaying image
            var display = function(pos, data){
                $('#' + pos).attr('src', data);
                $('#' + pos).css('display', 'inline-block');
                $('#' + pos).materialbox();
                $('.' + pos).css('height', '150px');
            };

            // for loading image
            var loadfile = function(event, pos){
                display(pos, URL.createObjectURL(event.target.files[0]));

                // // extracting dimensions
                // tmp_img.name = pos
                // tmp_img.src = URL.createObjectURL(event.target.files[0])
            };

            var properEncode = function(data){
                // removing data:image/jpeg;base64,
                data = data.toString().replace(/^data:(.*,)?/, '');

                // padding
                len = data.length
                if ((len % 4) > 0){
                    data += '='.repeat(4 - (len % 4));
                }
                return data
            }

            // for transfering images
            var transfer = function(){
                $('.loader').css('display', 'block');

                var content_image = $('#contentimage')[0].files[0];
                var style_image = $('#styleimage')[0].files[0];

                var contentFileReader = new FileReader();
                contentFileReader.readAsDataURL(content_image)              // DataURL (Base64)

                contentFileReader.onload = () => {
                    encoded_content = properEncode(contentFileReader.result)                    

                    var styleFileReader = new FileReader();
                    styleFileReader.readAsDataURL(style_image)

                    styleFileReader.onload = () => {
                        encoded_style = properEncode(styleFileReader.result)
                        // var d = new Date();

                        socket.emit('data', {
                            // 'id': d.getTime(),
                            'image1': {
                                // 'name': content_image.name, 
                                'type': content_image.type, 
                                'size': content_image.size,
                                'binary': encoded_content,
                                // 'width': cimg.width,
                                // 'height': cimg.height
                            },
                            'image2': {
                                // 'name': style_image.name, 
                                'type': style_image.type, 
                                'size': style_image.size, 
                                'binary': encoded_style,
                                // 'width': simg.width,
                                // 'height': simg.height
                            }
                        });
                    };

                    styleFileReader.onerror = () => {
                        alert('An error occured!');
                    };
                };

                contentFileReader.onerror = () => {
                    alert('An error occured!');
                };                
            };
        </script>
    </body>
</html>